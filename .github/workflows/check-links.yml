name: êµ¬ë§¤ ë§í¬ ì²´í¬

on:
  schedule:
    # ë§¤ì›” 1ì¼, 14ì¼ ì˜¤ì „ 9ì‹œ (KST) = 0ì‹œ UTC
    - cron: '0 0 1,14 * *'
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  check-links:
    runs-on: ubuntu-latest
    permissions:
      issues: write

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - run: npm ci

      - name: êµ¬ë§¤ ë§í¬ ì²´í¬ ì‹¤í–‰
        id: check
        run: |
          npx tsx scripts/check-purchase-links.ts 2>&1 | tee link-check-output.txt
          # í’ˆì ˆ/ì—ëŸ¬ê°€ ìˆìœ¼ë©´ í›„ì† ë‹¨ê³„ ì‹¤í–‰
          if grep -q 'ğŸ”´\|âŒ' link-check-output.txt; then
            echo "has_issues=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_issues=false" >> "$GITHUB_OUTPUT"
          fi

      - name: ë¬¸ì œ ë°œê²¬ ì‹œ ì´ë©”ì¼ ì•Œë¦¼
        if: steps.check.outputs.has_issues == 'true'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: 'ğŸ”— êµ¬ë§¤ ë§í¬ ì ê²€ í•„ìš” (${{ github.run_id }})'
          to: wogus2169@gmail.com
          from: ëŸ¬ë‹ì˜ëª¨ë“ ê²ƒ ë§í¬ì²´ì»¤
          body: |
            êµ¬ë§¤ ë§í¬ ìë™ ì ê²€ì—ì„œ ë¬¸ì œê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤.

            ì•„ë˜ ê²°ê³¼ë¥¼ í™•ì¸í•˜ê³  ë§í¬ë¥¼ ì—…ë°ì´íŠ¸í•´ì£¼ì„¸ìš”.

            ---
            ${{ steps.check.outputs.has_issues == 'true' && 'ë¬¸ì œê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤. ì²¨ë¶€ ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.' || 'ì •ìƒ' }}

            ì „ì²´ ë¡œê·¸: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

      - name: ë¬¸ì œ ë°œê²¬ ì‹œ Issue ìƒì„±
        if: steps.check.outputs.has_issues == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const output = fs.readFileSync('link-check-output.txt', 'utf8');
            const issues = output.split('\n').filter(l => l.includes('ğŸ”´') || l.includes('âŒ'));

            const body = `## êµ¬ë§¤ ë§í¬ ì ê²€ ê²°ê³¼

            ìë™ ì ê²€ì—ì„œ ë¬¸ì œê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤.

            \`\`\`
            ${issues.join('\n')}
            \`\`\`

            <details>
            <summary>ì „ì²´ ê²°ê³¼</summary>

            \`\`\`
            ${output}
            \`\`\`
            </details>

            > ìë™ ìƒì„±ëœ ì´ìŠˆì…ë‹ˆë‹¤. \`npx tsx scripts/check-purchase-links.ts\`ë¡œ ì¬í™•ì¸í•˜ì„¸ìš”.
            `.replace(/^            /gm, '');

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸ”— êµ¬ë§¤ ë§í¬ ì ê²€ í•„ìš” (${new Date().toISOString().slice(0, 10)})`,
              body,
              labels: ['link-check']
            });
